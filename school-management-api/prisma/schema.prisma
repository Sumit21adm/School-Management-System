// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Student and Admission Tables
model StudentDetails {
  id              Int       @id @default(autoincrement())
  studentId       String    @unique @db.VarChar(20)
  name            String    @db.VarChar(100)
  fatherName      String    @db.VarChar(100)
  motherName      String    @db.VarChar(100)
  dob             DateTime  @db.Date
  gender          String    @db.VarChar(10)
  className       String    @db.VarChar(20)
  section         String    @db.VarChar(5)
  admissionDate   DateTime  @db.Date
  address         String    @db.Text
  phone           String    @db.VarChar(15)
  email           String?   @db.VarChar(100)
  photoUrl        String?   @db.VarChar(255)
  fatherOccupation String?  @db.VarChar(100)
  motherOccupation String?  @db.VarChar(100)
  aadharCardNo    String?   @unique @db.VarChar(20)
  whatsAppNo      String?   @db.VarChar(15)
  subjects        String?   @db.VarChar(255)
  status          String    @default("active") @db.VarChar(20)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  feeTransactions FeeTransaction[]
  discounts       StudentFeeDiscount[]

  @@map("student_details")
}

// Fee Tables
model FeeTransaction {
  id            Int      @id @default(autoincrement())
  transactionId String   @unique @db.VarChar(50)
  studentId     String   @db.VarChar(20)
  receiptNo     String   @unique @db.VarChar(50)
  amount        Decimal  @db.Decimal(10, 2)
  description   String   @db.VarChar(100)
  paymentMode   String   @db.VarChar(20)
  date          DateTime @db.Date
  yearId        Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  student       StudentDetails @relation(fields: [studentId], references: [studentId])

  @@index([studentId])
  @@index([date])
  @@map("feetransaction_new")
}

// Academic Session Management
model AcademicSession {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(30)
  startDate   DateTime @db.Date
  endDate     DateTime @db.Date
  isActive    Boolean  @default(false)
  isSetupMode Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  feeStructures FeeStructure[]
  discounts     StudentFeeDiscount[]

  @@index([isActive])
  @@index([startDate, endDate])
  @@map("academic_sessions")
}

// Fee Management
model FeeType {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(50)
  description String?  @db.VarChar(200)
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  structureItems FeeStructureItem[]
  discounts      StudentFeeDiscount[]

  @@index([isActive])
  @@map("fee_types")
}

model FeeStructure {
  id          Int      @id @default(autoincrement())
  sessionId   Int
  className   String   @db.VarChar(20)
  description String?  @db.VarChar(200)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  session    AcademicSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  feeItems   FeeStructureItem[]

  @@unique([sessionId, className])
  @@index([sessionId])
  @@map("fee_structures")
}

model FeeStructureItem {
  id          Int      @id @default(autoincrement())
  structureId Int
  feeTypeId   Int
  amount      Decimal  @db.Decimal(10, 2)
  isOptional  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  structure FeeStructure @relation(fields: [structureId], references: [id], onDelete: Cascade)
  feeType   FeeType      @relation(fields: [feeTypeId], references: [id])

  @@unique([structureId, feeTypeId])
  @@index([structureId])
  @@index([feeTypeId])
  @@map("fee_structure_items")
}

model StudentFeeDiscount {
  id            Int          @id @default(autoincrement())
  studentId     String       @db.VarChar(20)
  feeTypeId     Int
  sessionId     Int
  discountType  DiscountType
  discountValue Decimal      @db.Decimal(10, 2)
  reason        String?      @db.VarChar(200)
  approvedBy    String?      @db.VarChar(100)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  student StudentDetails  @relation(fields: [studentId], references: [studentId], onDelete: Cascade)
  feeType FeeType         @relation(fields: [feeTypeId], references: [id])
  session AcademicSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([studentId, feeTypeId, sessionId])
  @@index([studentId])
  @@index([feeTypeId])
  @@index([sessionId])
  @@map("student_fee_discounts")
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

// Exam Tables



// Inventory Tables
model Inventory {
  id          Int      @id @default(autoincrement())
  itemCode    String   @unique @db.VarChar(20)
  itemName    String   @db.VarChar(200)
  category    String   @db.VarChar(50)
  quantity    Int
  unit        String   @db.VarChar(20)
  price       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  movements   StockMovement[]

  @@map("inventory")
}

model StockMovement {
  id          Int      @id @default(autoincrement())
  itemId      Int
  movementType String  @db.VarChar(20)
  quantity    Int
  remarks     String?  @db.Text
  createdAt   DateTime @default(now())

  item        Inventory @relation(fields: [itemId], references: [id])

  @@index([itemId])
  @@map("stock_movements")
}

// User/Auth Tables
model User {
  id          Int      @id @default(autoincrement())
  username    String   @unique @db.VarChar(50)
  password    String   @db.VarChar(255)
  role        String   @db.VarChar(20)
  name        String   @db.VarChar(100)
  email       String?  @db.VarChar(100)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("users")
}
